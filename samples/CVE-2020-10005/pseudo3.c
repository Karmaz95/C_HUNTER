#include <stddef.h>
#include <stdint.h>
#include <string.h>

typedef unsigned char uchar;
typedef uint16_t ushort;
typedef uint64_t undefined8;

typedef struct {
    short short_1_StructureSize;
    short short_2_Flags;
    short short_3_PathOffset;
    short short_4_PathLength;
    void* buf;
} tree_connect_request;

/**
 * SMB2 Extract function
 * Extracts tree connect request fields from the SMB2 packet.
 */
undefined8 smb2_extract(uchar **pkt_ptr_ptr, uchar **packet_size_hdr_ptr_ptr, 
                        tree_connect_request *memcpy_src, uchar **smb_hdr_ptr_ptr) 
{
    short *packet_ptr = (short *)*pkt_ptr_ptr;
    short *packetEnd;
    ushort tc_PathOffset, tc_PathLength;
    short tc_StructureSize;

    if ((long)*packet_size_hdr_ptr_ptr - (long)packet_ptr < 8) {
        return 0;
    }

    tc_StructureSize = *packet_ptr;
    *pkt_ptr_ptr = (uchar *)(packet_ptr + 1);
    memcpy_src->short_1_StructureSize = tc_StructureSize;

    if (tc_StructureSize == 9) {
        *pkt_ptr_ptr = (uchar *)(packet_ptr + 2);
        memcpy_src->short_2_Flags = 0;

        tc_PathOffset = packet_ptr[2];
        *pkt_ptr_ptr = (uchar *)(packet_ptr + 3);
        memcpy_src->short_3_PathOffset = tc_PathOffset;

        tc_PathLength = packet_ptr[3];
        *pkt_ptr_ptr = (uchar *)(packet_ptr + 4);
        memcpy_src->short_4_PathLength = tc_PathLength;

        packetEnd = (short *)(*smb_hdr_ptr_ptr + tc_PathOffset + 
                             ((uint)(*smb_hdr_ptr_ptr + tc_PathOffset) & 1));
        *pkt_ptr_ptr = (uchar *)packetEnd;

        if (packet_ptr <= packetEnd && packetEnd <= (short *)*packet_size_hdr_ptr_ptr) {
            packetEnd = (short *)((long)packetEnd + (ulong)tc_PathLength);
            if ((short *)*packet_size_hdr_ptr_ptr < packetEnd) {
                packetEnd = (short *)*packet_size_hdr_ptr_ptr;
            }
            return smb_extract_utf16_string(pkt_ptr_ptr, (uchar *)packetEnd, &memcpy_src->buf);
        }
    }

    return 0;
}

/**
 * SMB2 Dispatch Tree Connect function
 * Processes an SMB2 Tree Connect request.
 */
ulong smb2_dispatch_tree_connect(smb_request *request, uchar *in_packet_ptr, uchar *in_packet_size)
{
    uchar *packet_input_ptr = in_packet_ptr;
    uchar *packet_size = in_packet_size;
    tree_connect_request memcpy_src = {0};
    wchar_t wcSharePath[1024] = {0}; 
    ulong num_chars = 1;
    uint bitmasked_num_chars;

    if (!smb2_extract(&packet_input_ptr, &packet_size, &memcpy_src, &request->smb_hdr_ptr)) {
        return 0xc00000be;
    }

    if (!memcpy_src.buf) {
        return 0xc00000be;
    }

    bitmasked_num_chars = (uint)num_chars & 0x3fffffff;
    num_chars = (ulong)bitmasked_num_chars;

    if (bitmasked_num_chars == 0) {
        return 0xc00000be;
    }

    if (*(short *)((uintptr_t)memcpy_src.buf + num_chars * 2 - 2) != 0) {
        memcpy(wcSharePath, memcpy_src.buf, num_chars * 2);
        wcSharePath[num_chars] = L'\0';
    }

    bitmasked_num_chars = connect_to_named_tree(request, (void *)&wcSharePath, NULL);
    return bitmasked_num_chars;
}
